generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Auction {
  id              String    @id @default(cuid())
  externalId      String    @unique
  platform        Platform
  url             String
  title           String
  make            String
  model           String
  year            Int
  trim            String?
  vin             String?
  mileage         Int?
  mileageUnit     String    @default("miles")
  transmission    String?
  engine          String?
  exteriorColor   String?
  interiorColor   String?
  location        String?
  currentBid      Float?
  reserveStatus   ReserveStatus?
  bidCount        Int       @default(0)
  viewCount       Int?
  watchCount      Int?
  startTime       DateTime?
  endTime         DateTime?
  status          AuctionStatus @default(ACTIVE)
  finalPrice      Float?
  description     String?   @db.Text
  sellerNotes     String?   @db.Text
  images          String[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  scrapedAt       DateTime  @default(now())
  analysis        Analysis?
  comparables     Comparable[]
  priceHistory    PriceHistory[]
  @@index([platform])
  @@index([make, model])
  @@index([status])
  @@index([endTime])
}

model Analysis {
  id              String    @id @default(cuid())
  auctionId       String    @unique
  auction         Auction   @relation(fields: [auctionId], references: [id])
  bidTargetLow    Float?
  bidTargetHigh   Float?
  confidence      AnalysisConfidence?
  criticalQuestions String[]
  redFlags        String[]
  keyStrengths    String[]
  yearlyMaintenance Float?
  insuranceEstimate Float?
  majorServiceCost  Float?
  investmentGrade InvestmentGrade?
  appreciationPotential String?
  rawAnalysis     Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Comparable {
  id              String    @id @default(cuid())
  auctionId       String
  auction         Auction   @relation(fields: [auctionId], references: [id])
  title           String
  platform        Platform
  url             String?
  soldDate        DateTime?
  soldPrice       Float
  mileage         Int?
  condition       String?
  createdAt       DateTime  @default(now())
}

model PriceHistory {
  id              String    @id @default(cuid())
  auctionId       String
  auction         Auction   @relation(fields: [auctionId], references: [id])
  bid             Float
  timestamp       DateTime  @default(now())
}

model MarketData {
  id              String    @id @default(cuid())
  make            String
  model           String
  yearStart       Int?
  yearEnd         Int?
  avgPrice        Float?
  medianPrice     Float?
  lowPrice        Float?
  highPrice       Float?
  totalSales      Int       @default(0)
  trend           MarketTrend?
  lastUpdated     DateTime  @default(now())
  @@unique([make, model, yearStart, yearEnd])
}

// ═══════════════════════════════════════════════════════════════════════════
// USER & CREDITS SYSTEM
// ═══════════════════════════════════════════════════════════════════════════

model User {
  id              String    @id @default(cuid())
  supabaseId      String    @unique
  email           String    @unique
  name            String?
  avatarUrl       String?

  // Credits System
  creditsBalance  Int       @default(3)
  freeCreditsUsed Int       @default(0)
  creditResetDate DateTime  @default(now())

  // Subscription tier
  tier            UserTier  @default(FREE)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  transactions    CreditTransaction[]
  analyses        UserAnalysis[]

  @@index([supabaseId])
  @@index([email])
}

model CreditTransaction {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id])

  amount          Int             // Positive = added, Negative = used
  type            TransactionType
  description     String?

  stripePaymentId String?         // For purchases

  createdAt       DateTime        @default(now())

  @@index([userId])
  @@index([type])
}

model UserAnalysis {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  auctionId       String

  creditCost      Int       @default(1)
  createdAt       DateTime  @default(now())

  @@unique([userId, auctionId])
  @@index([userId])
}

enum UserTier {
  FREE
  PRO
}

enum TransactionType {
  FREE_MONTHLY
  PURCHASE
  ANALYSIS_USED
  BONUS
  REFUND
}

enum Platform {
  BRING_A_TRAILER
  CARS_AND_BIDS
  COLLECTING_CARS
}

enum AuctionStatus {
  ACTIVE
  ENDING_SOON
  ENDED
  SOLD
  NO_SALE
}

enum ReserveStatus {
  NO_RESERVE
  RESERVE_NOT_MET
  RESERVE_MET
}

enum AnalysisConfidence {
  HIGH
  MEDIUM
  LOW
}

enum InvestmentGrade {
  EXCELLENT
  GOOD
  FAIR
  SPECULATIVE
}

enum MarketTrend {
  APPRECIATING
  STABLE
  DECLINING
}

// ═══════════════════════════════════════════════════════════════════════════
// HISTORICAL BACKFILL TRACKING
// ═══════════════════════════════════════════════════════════════════════════

model ModelBackfillState {
  id            String   @id @default(cuid())
  make          String
  model         String
  status        BackfillStatus @default(PENDING)
  backfilledAt  DateTime?
  auctionCount  Int      @default(0)
  errorMessage  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([make, model])
  @@index([status])
}

enum BackfillStatus {
  PENDING
  BACKFILLED
  FAILED
}
